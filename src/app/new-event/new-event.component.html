<p-dialog
  [(visible)]="visible"
  (visibleChange)="onInternalVisibleChange($event)"
  (onHide)="onInternalHide()"
  [modal]="true"
  [style]="{ width: '640px' }"
  [dismissableMask]="true"
  [closeOnEscape]="true"
  [draggable]="false"
  [appendTo]="'body'"
  [autoZIndex]="true"
  [baseZIndex]="1100"
  header="{{ data.mode === 'create' ? 'Nuevo evento' : 'Editar evento' }}"
>
  <form [formGroup]="form" style="padding: 8px 24px">
    <div
      style="
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        align-items: start;
      "
    >
      <div class="p-field">
        <label for="title">Título*</label>
        <input id="title" pInputText class="w-full" formControlName="title" />
        <small
          class="p-error"
          *ngIf="form.controls['title'].hasError('required')"
          >Campo obligatorio</small
        >
        <small
          class="p-error"
          *ngIf="form.controls['title'].hasError('maxlength')"
          >Máximo {{ TITLE_MAX }} caracteres</small
        >
      </div>

      <div class="p-field">
        <label for="location">Ubicación</label>
        <input
          id="location"
          pInputText
          class="w-full"
          formControlName="location"
        />
      </div>

      <div class="p-field" style="grid-column: span 2">
        <label for="description">Descripción</label>
        <textarea
          id="description"
          pInputTextarea
          rows="3"
          class="w-full"
          formControlName="description"
        ></textarea>
      </div>

      <div class="p-formgrid p-grid" style="grid-column: span 2">
        <div class="p-field p-col-12 p-md-6">
          <label for="dateStart">Fecha inicio*</label>
          <p-calendar
            id="dateStart"
            formControlName="dateStart"
            [readonlyInput]="true"
            [showIcon]="true"
            [touchUI]="true"
            [showButtonBar]="true"
            dateFormat="dd/mm/yy"
          >
          </p-calendar>
        </div>

        <div class="p-field p-col-12 p-md-6">
          <label for="dateEnd">Fecha fin</label>
          <p-calendar
            id="dateEnd"
            formControlName="dateEnd"
            [readonlyInput]="true"
            [showIcon]="true"
            [touchUI]="true"
            [showButtonBar]="true"
            dateFormat="dd/mm/yy"
          >
          </p-calendar>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <p-inputSwitch
          formControlName="allDay"
          (onChange)="onAllDayToggle()"
        ></p-inputSwitch>
        <label>Todo el día</label>
      </div>
      <small class="p-error" *ngIf="form.hasError('range')">
        La fecha/hora de finalización debe ser posterior al inicio
      </small>

      <!-- Время (отключается для allDay) -->
      @if (!form.value.allDay) {
      <div class="p-formgrid p-grid" *ngIf="!form.value.allDay">
        <div class="p-field p-col-6">
          <label for="timeStart">Hora de inicio</label>
          <p-dropdown
            id="timeStart"
            [options]="allTimes"
            formControlName="timeStart"
            [autoDisplayFirst]="false"
          >
            <ng-template let-opt pTemplate="item">
              <div>{{ opt }}</div>
            </ng-template>
          </p-dropdown>
        </div>

        <div class="p-field p-col-6">
          <label for="timeEnd">Hora de fin</label>
          <p-dropdown
            id="timeEnd"
            [options]="endTimes()"
            optionLabel="label"
            optionValue="value"
            formControlName="timeEnd"
            [autoDisplayFirst]="false"
          >
            <ng-template let-opt pTemplate="item">
              <div>{{ opt.label }}</div>
            </ng-template>
          </p-dropdown>
        </div>
      </div>
      }
    </div>
  </form>

  <ng-template pTemplate="footer">
    <p-button
      label="{{ data.mode === 'create' ? 'Crear' : 'Guardar' }}"
      [disabled]="form.invalid"
      (onClick)="onSubmit()"
    ></p-button>
    <p-button
      label="Cancelar"
      severity="secondary"
      (onClick)="close()"
    ></p-button>
    <p-button
      *ngIf="data.mode === 'edit'"
      label="Eliminar"
      severity="danger"
      (onClick)="remove()"
    ></p-button>
  </ng-template>
</p-dialog>
